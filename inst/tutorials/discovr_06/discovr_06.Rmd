---
title: "discovr: the beast of bias"
author: "Andy Field"
output:
  learnr::tutorial:
    progressive: false
    theme: "united"
    css: ./css/discovr_style_future.css
runtime: shiny_prerendered
description: "The beast of bias. Visualizing the data, fitting GLMs with one and two predictors. Viewing model parameters with broom, model parameters, standard errors, confidence intervals, fit statistics, significance."
bibliography: discovr_06.bib
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = TRUE,
	message = FALSE,
	warning = FALSE
)

library(learnr)
library(magrittr)
library(ggplot2)

source("./www/discovr_helpers.R")

#Read dat files needed for the tutorial

album_tib <- discovr::album_sales
soc_anx_tib <- discovr::social_anxiety
metal_tib <- discovr::metal_health
```


# discovr: The beast of bias

## Overview

<div class="infobox">
  <img src="./images/discovr_hex.png" alt="discovr package hex sticker, female space pirate with gun. Gunsmoke forms the letter R." style="width:100px;height:116px;" class = "img_left">
  
  **Usage:** This tutorial accompanies [Discovering Statistics Using R and RStudio](https://www.discoveringstatistics.com/books/discovering-statistics-using-r/) [@field_discovering_2021] by [Andy Field](https://en.wikipedia.org/wiki/Andy_Field_(academic)). It contains material from the book so there are some copyright considerations but I offer them under a [Creative Commons Attribution-NonCommercial-NoDerivatives 4.0 International License](http://creativecommons.org/licenses/by-nc-nd/4.0/). Tl;dr: you can use this tutorial for teaching and non-profit activities but please don't meddle with it or claim it as your own work.
  
</div>

### `r cat_space(height = 2)` Welcome to space pirate academy

Hi, welcome to **discovr** space pirate academy. Well done on embarking on this brave mission to planet `r rproj()`s, which is a bit like Mars, but a less red and more hostile environment. That's right, more hostile than a planet without water. Fear not though, the fact you are here means that you *can* master `r rproj()`, and before you know it you'll be as brilliant as our pirate leader Mae Jemstone (she's the badass with the gun). I am the space cat-det, and I will pop up to offer you tips along your journey.

On your way you will face many challenges, but follow Mae's system to keep yourself on track:

* `r bmu2(height = 2)` This icon flags materials for *teleporters*. That's what we like to call the new cat-dets, you know, the ones who have just teleported into the academy. This material is the core knowledge that everyone arriving at space academy must learn and practice.
* `r user_visor(height = 2)` Once you have been at space pirate academy for a while, you get your own funky visor. It has various modes. My favourite is the one that allows you to see everything as a large plate of tuna. More important, sections marked for cat-dets with visors goes beyond the core material but is still important and should be studied by all cat-dets. However, try not to be disheartened if you find it difficult.
* `r user_astronaut(height = 2)` Those almost as brilliant as Mae (because no-one is quite as brilliant as her) get their own space suits so that they can go on space pirate adventures. They get to shout *RRRRRR* really loudly too. Actually, everyone here gets to should *RRRRRR* really loudly. Try it now. Go on. It feels good. Anyway, this material is the most advanced and you can consider it optional unless you are a postgraduate cat-det.

It's not just me that's here to help though, you will meet other characters along the way:

* `r robot(height = 2)` **bend-R** is our coding robot. She will help you to try out bits of `r rproj()` by writing the code for you.
* `r bug(height = 2)` we also have alien bugs that will, erm, help you to avoid bugs by setting you coding challenges. 

By for now and good luck - you'll be amazing!

### Workflow

* Before attempting this tutorial it's a good idea to work through [this tutorial on how to install, set up and work within `r rproj()` and ![](./images/rstudio_logo.png){height=1em}](http://milton-the-cat.rocks/learnr/r/r_getting_started/).

* The tutorials are self-contained (you practice code in code boxes). However, so you get practice at working in ![](./images/rstudio_logo.png){height=1em} I strongly recommend that you create an `r rproj()` markdown file within an ![](./images/rstudio_logo.png){height=1em} project and practice everything you do in the tutorial in the `r rproj()` markdown file, make notes on things that confused you or that you want to remember, and save it. Within this markdown file you will need to load the relevant packages and data. 

![](https://youtu.be/FE0ntX0dyc4)

### Packages

This tutorial uses the following packages:

* `broom` [@robinsonBroomConvertStatistical2019]
* `GGally` [@Schloerke_Crowley_Cook_Briatte_Marbach_Thoen_Elberg_Larmarange_2018]
* `here` [@here]
* `lm.beta` [@behrendtLmBetaAdd2014]
* `tidyverse` [@tidyverse]

I try to follow the [Google `r rproj()` style guide](https://google.github.io/styleguide/Rguide.html) and [tidyverse style guide](https://style.tidyverse.org/) in always declaring the package when using a function: `package::function()`. For example, if I want to use the `mutate()` function from the package `dplyr`, I will write `dplyr::mutate()`. 

It is good practice to be explicit about packages to avoid clashes where functions from different packages have the same name. It also means that you don't need to load packages at the start of your markdown document. 

There are two main exceptions to this rule.

1. There are functions within some `tidyverse` packages that would be used within other functions. Including the package name makes the code difficult to read. Also, no-one wants to write `ggplot2::` before every function from `ggplot2`.
2. To use the pipe operator (`%>%`) you need to have `magritrr` loaded.

We can load all of the packages that are exceptions in one step by loading `tidyverse` at the beginning of our `r rproj()` Markdown document:

```{r eval = FALSE}
library(tidyverse)
```

### Data

To work *outside of this tutorial* you need to download the following data files:

* [album_sales.csv](http://www.discoveringstatistics.com/repository/discovr_data/album_sales.csv)
* [metal_health.csv](http://www.discoveringstatistics.com/repository/discovr_data/metal_health.csv)
* [social_anxiety.csv](http://www.discoveringstatistics.com/repository/discovr_data/social_anxiety.csv)

Set up an ![](./images/rstudio_logo.png){height=1em} project in the way that [I recommend in this tutorial](http://milton-the-cat.rocks/learnr/r/r_getting_started/#section-working-in-rstudio), and save the data files to the folder within your project called `data`. Place this code in the first code chunk in your `r rproj()` Markdown document:

```{r, eval=FALSE}
album_tib <- here::here("data/album_sales.csv") %>% readr::read_csv()
soc_anx_tib <- here::here("data/social_anxiety.csv") %>% readr::read_csv()
metal_tib <- here::here("data/metal_health.csv")  %>% readr::read_csv()
```


## Assumptions

Use this interactive app, written by [Mine Ã‡etinkaya-Rundel](https://www2.stat.duke.edu/~mc301/) to explore how violations of model assumptions affect residual plots. The options [linear up]{.alt} and [linear down]{.alt} show residual plots when assumptions are met, [curved up]{.alt} and [curved down]{.alt} show how curvilearity in the data affect the residual plots and [fan-shaped]{.alt} shows the effect of heteroscedasticity. (If the app isn't displaying view it online at [https://gallery.shinyapps.io/slr_diag/](https://gallery.shinyapps.io/slr_diag/).)

```{r, echo = FALSE}
knitr::include_app("https://gallery.shinyapps.io/slr_diag/", height = "500px")
```

## Bootstrapping

```{r bt_ui, echo = FALSE}
# define UI
fluidPage(
        
        p("This app is designed to give you a sense of how bootstrapping works by letting you become a bootstrap machine!
              Using the example from the book Chapter, Meston & Frohlich (2003) report a study showing that heterosexual people 
              rate a picture of someone of the opposite sex as more attractive after riding a roller-coaster compared to before. 
              Imagine we took 20 people as they came off the Rockit roller-coaster at Universal studios in Orlando and asked 
              them to rate the attractiveness of someone in a photograph on a scale of 0 (looks like Jabba the Hut) to 10 
              (looks like Princess Leia or Han Solo). The sample data below shows the 20 attractiveness ratings recorded in the study.
              We want to bootstrap the mean attractiveness rating to get a robust estimate of the mean and its confidence interval.
              Everytime you hit the button, a bootstrap sample will be taken, the mean in that sample calculated and then added to a histogram
          showing the means from all of the bootstrap samples to date."),
          p("To get the best results click the button 20-50 times. Each time you click the button note:"),
            p("- Each bootstrap sample is the same size as the observed sample, but it does not contain the same scores because each observed 
              score could be sampled more than once."),
        p("- Because each bootstrap sample is different to the observed sample, it usually has a slightly different mean."),
            p("- Each bootstrap sample contains only values from the observed sample. For example, the value 2 doesn't occur in the observed data
              and so won't occur in any bootstrap samples"),
            p("- The centre of the distribution of bootstrap sample means (the black line) is our robust estimate of the mean. At first it fluctuates, but as you take
            more samples it will stabilize."),
            p("- The width of the distribution of bootstrap sample means relates to the estimate of the standard error of the mean"),
        
        
        div(actionButton("lets_boot", "Take bootstrap sample"), align = "center"),
        div(actionLink("reset", "Reset"), align = "center"),
        
        hr(),
        
        fluidRow(
            column(6,
                   h3("Sample data"),
                   div(p(textOutput("sample_data")), align = "center"),
                   div(h4(textOutput("sample_mean")), align = "center"),
                   plotOutput("sample_plot", height = "200px")
                   ),
            column(6,
                   h3("Bootstrap sample data"),
                   div(p(textOutput("boot_sample")), align = "center"),
                   div(h4(textOutput("boot_mean")), align = "center"),
                   plotOutput("boot_plot", height = "200px")
                   )
        ),
        
        hr(),
        
        
        fluidRow(
            h3("Distribution of bootstrap means"),
            div(p(textOutput("all_boot_mean")), align = "center"),
            div(h4(textOutput("all_boot_mean_mean")), align = "center"),
            plotOutput("sd_plot", height = "200px")
        )
    )
```


```{r bt_server, context = "server", echo = FALSE}

all_boot <- tibble::tibble(
        mean = numeric()
    )
    
    sample_dat <- tibble::tibble(
        attractiveness = c(0, 0, 3, 4, 4, 5, 5, 6, 6, 6, 6, 7, 7, 7, 8, 8, 9, 9, 10, 10)
    )

    get_hist <- function(tibble){
        ggplot2::ggplot(tibble, aes(x = attractiveness)) + 
            geom_histogram(binwidth = 1, fill = "#9cbfbc", colour = "#5ea5a8", alpha = 0.7) +
            coord_cartesian(ylim = c(0, 10), xlim = c(0, 10)) +
            scale_x_continuous(breaks = 0:10) +
            scale_y_continuous(breaks = 0:10) +
            labs(x = "Attractiveness", y = "Frequency") +
            theme_minimal()
    }
    
    get_text_data <- function(var){
        paste(var, collapse = ", ") 
    }
    
    output$sample_data <- renderText(
        get_text_data(sample_dat$attractiveness)
        )
    
    output$sample_mean <- renderText(
        paste0("Boostrap sample mean = ", mean(sample_dat$attractiveness))
    )
    
    output$sample_plot = renderPlot(
        get_hist(sample_dat)
    )
    
    
    output$boot_plot <- NULL
    output$sd_plot <- NULL
    

    observeEvent(input$lets_boot, {
        #invalidateLater(1000, session)
        current_boot <- tibble::tibble(
            attractiveness = sample(sample_dat$attractiveness, nrow(sample_dat), replace=TRUE)
            ) %>% 
            dplyr::arrange(attractiveness)
            
        #current_boot[["mean"]] <- mean(current_boot[["data"]])
        output$boot_sample = renderText(
            get_text_data(current_boot$attractiveness)
            )
        output$boot_mean = renderText(
            paste0("Boostrap sample mean = ", mean(current_boot$attractiveness))
            )
        output$boot_plot = renderPlot(get_hist(current_boot))
        all_boot <<- all_boot %>% tibble::add_row(mean = mean(current_boot$attractiveness))  
        output$all_boot_mean = renderText(get_text_data(all_boot$mean))
        output$all_boot_mean_mean = renderText(
            paste0("Mean of bootstrap means = ", round(mean(all_boot$mean), 2))
        )
        
        output$sd_plot <- renderPlot(
            ggplot2::ggplot(all_boot, aes(x = mean)) + 
                geom_histogram(binwidth = 0.5, fill = "#E8655C", colour = "#d35c54", alpha = 0.7) +
                coord_cartesian(xlim = c(2, 9)) +
                scale_x_continuous(breaks = 2:9) +
                geom_vline(xintercept = mean(all_boot$mean)) +
                labs(x = "Bootstrap sample mean", y = "Frequency") +
                theme_minimal()
        )
    })
    
     observeEvent(input$reset, {
        output$boot_sample = NULL
        output$boot_mean = NULL
        output$boot_plot = NULL
        all_boot <<- tibble::tibble(
            mean = numeric()
        ) 
        output$all_boot_mean = NULL
        output$all_boot_mean_mean = NULL
        output$sd_plot <- NULL
    })

```



## Resources {data-progressive=FALSE}

### Statistics

* The tutorials typically follow examples described in detail in @field_discovering_2021. That book covers the theoretical side of the statistical models, and has more depth on conducting and interpreting the models in these tutorials.
* If any of the statistical content doesn't make sense, you could try my more introductory book *An adventure in statistics* [@fieldAdventureStatisticsReality2016].
* There are free lectures and screencasts on my [YouTube channel](https://www.youtube.com/user/ProfAndyField/).
* There are free statistical resources on my websites [www.discoveringstatistics.com](http://www.discoveringstatistics.com) and [milton-the-cat.rocks](http://milton-the-cat.rocks).

### `r rproj("h3")`

* [R for data science](http://r4ds.had.co.nz/index.html) by @wickhamDataScience2017 is an open-access book by the creator of the tidyverse (Hadley Wickham). It covers the *tidyverse* and data management.
* [ModernDive](http://moderndive.com/index.html) is an open-access textbook on `r rproj("h3")` and ![](./images/rstudio_logo.png){height=1em}.
* [![](./images/rstudio_logo.png){height=1em} cheat sheets](https://www.rstudio.com/resources/cheatsheets/).
* [![](./images/rstudio_logo.png){height=1em} list of online resources](https://www.rstudio.com/online-learning/).

### Acknowledgement

I'm extremely grateful to [Allison Horst](https://www.allisonhorst.com/) for her very informative blog post on [styling learnr tutorials with CSS](https://education.rstudio.com/blog/2020/05/learnr-for-remote/) and also for sending me a CSS template file and allowing me to adapt it. Without Allison, these tutorials would look a lot worse (but she can't be blamed for my colour scheme).

## References


